tribe.events=tribe.events||{},tribe.events.facebookSettingsAdmin=tribe.events.facebookSettingsAdmin||{},function(e,t){const a=e(document);t.GraphVersion="v9.0",t.selectors={messageWrap:".tribe-events-virtual-settings-message__wrap",facebookContainer:".tribe-settings-facebook-integration",facebookSaveApp:".tribe-settings-facebook-application__connect-container",facebookSaveAppBtn:".tribe-settings-facebook-application__connect-button",facebookPages:".tribe-settings-facebook-application-pages__container",facebookPageList:".tribe-settings-facebook-page-list",facebookAddPage:".tribe-events-virtual-meetings-facebook-settings__add-page-button",facebookPageContainer:".tribe-settings-facebook-page-details__container",facebookAppMessageContainer:".tec-facebook-app-messages",facebookPageMessageContainer:".tec-facebook-page-messages",facebookPageName:".tribe-settings-facebook-page-details__page-name-input",facebookPageId:".tribe-settings-facebook-page-details__page-id-input",facebookAccessToken:".tribe-settings-facebook-page-details__page-access-token-input",facebookClearAccess:".tribe-settings-facebook-page-details__clear-access",facebookDeletePage:".tribe-settings-facebook-page-details__delete-page",facebookSavePage:".tribe-settings-facebook-page-details__save-page",facebookAppId:'input[name="tribe_facebook_app_id"]',facebookAppSecret:'input[name="tribe_facebook_app_secret"]',autoDetectPreviewClass:".tec-virtual-video-embed__facebook"},t.onAppSaveSuccess=function(a){const o=e(a).filter(t.selectors.messageWrap),s=e(a).filter(t.selectors.facebookPages);e(t.selectors.facebookAppMessageContainer).html(o),0!==s.length&&e(t.selectors.facebookSaveApp).replaceWith(s)},t.handleSaveApp=function(a){a.preventDefault();const o=e(this).data("ajaxSaveUrl"),s=e(t.selectors.facebookAppId).val(),c=e(t.selectors.facebookAppSecret).val();e.ajax(o,{contentType:"application/json",context:e(this).closest(t.selectors.facebookContainer),data:{facebook_app_id:s,facebook_app_secret:c},success:t.onAppSaveSuccess})},t.handleEnableSave=function(){const a=e(this).closest(t.selectors.facebookPageContainer),o=a.find(t.selectors.facebookPageName).val(),s=a.find(t.selectors.facebookPageId).val(),c=a.find(t.selectors.facebookSavePage);c.prop("disabled",!0),o&&s&&c.prop("disabled",!1)},t.onPageSaveSuccess=function(o){const s=e(o).filter(t.selectors.messageWrap),c=e(o).filter(t.selectors.facebookPageContainer);if(e(t.selectors.facebookPageMessageContainer).html(s),0===c.length)return;const n=c.data("localId");a.find(`[data-local-id='${n}']`).replaceWith(c),FB.XFBML.parse()},t.handleSavePage=function(a){a.preventDefault();const o=e(this),s=o.data("ajaxSaveUrl"),c=o.closest(t.selectors.facebookPageContainer),n=c.data("localId"),i=c.find(t.selectors.facebookPageName).val(),r=c.find(t.selectors.facebookPageId).val(),l=c.find(t.selectors.facebookAccessToken).val();e.ajax(s,{contentType:"application/json",context:e(this).closest(t.selectors.facebookPageContainer),data:{local_id:n,page_name:i,page_id:r,access_token:l},success:t.onPageSaveSuccess})},t.handleClearAccess=function(a){a.preventDefault();const o=e(this),s=o.attr("href"),c=o.closest(t.selectors.facebookPageContainer),n=c.data("localId");confirm(tribe_events_virtual_facebook_settings_strings.pageClearAccessConfirmation)&&e.ajax(s,{contentType:"application/json",context:c,data:{local_id:n},success:t.onPageSaveSuccess})},t.onPageDeleteSuccess=function(a){e(t.selectors.facebookPageMessageContainer).html(a),e(`${t.selectors.facebookPageContainer}.to-delete`).remove()},t.handleDeletePage=function(a){a.preventDefault();const o=e(this),s=o.data("ajaxDeleteUrl"),c=o.closest(t.selectors.facebookPageContainer),n=c.data("localId");confirm(tribe_events_virtual_facebook_settings_strings.pageDeleteConfirmation)&&(c.addClass("to-delete"),e.ajax(s,{contentType:"application/json",context:e(this).closest(t.selectors.facebookPageContainer),data:{local_id:n},success:t.onPageDeleteSuccess}))},t.facebookInit=function(){if("undefined"==typeof FB)return!1;let a=e(t.selectors.facebookAppId).val();(!a||a<1)&&(a=tribe_events_virtual_facebook_settings_strings.facebookAppId),!a||a<1||FB.init({appId:a,autoLogAppEvents:!0,xfbml:!0,version:t.GraphVersion})},t.displayMessage=function(a,o="updated"){const s=`\n\t\t\t<div\n\t\t\t\tid="tribe-events-virtual-settings-message"\n\t\t\t\tclass="tribe-events-virtual-settings-message__wrap ${o}"\n\t\t\t>\n\t\t\t\t${a}\n\t\t\t</div>\n\t\t`;e(t.selectors.facebookPageMessageContainer).html(s)},t.handleSavePageAccess=function(a,o,s,c){const n=o.data("ajaxSaveAccessUrl");e.ajax(n,{contentType:"application/json",context:o,data:{local_id:a,page_id:s,access_token:c},success:t.onPageSaveSuccess})},t.getPageAccessToken=function(a,o,s){e.ajax({url:`https://graph.facebook.com/${a}?fields=access_token&access_token=${o}`,type:"GET",dataType:"json",success:function(e){if(void 0!==e.access_token)s.find(t.selectors.facebookAccessToken).val(e.access_token),t.handleSavePageAccess(s.data("localId"),s,a,e.access_token);else{const e=tribe_events_virtual_facebook_settings_strings.pageTokenFailure,a="no page access token";t.displayMessage(`${e}: ${a}`,"error")}},error:function(e,a,o){const s=tribe_events_virtual_facebook_settings_strings.pageTokenFailure;t.displayMessage(`${s}: ${o}`,"error")}})},t.getExtendedAccessToken=function(a,o,s,c,n){if(a&&o&&s&&c&&n)e.ajax({url:`https://graph.facebook.com/oauth/access_token?grant_type=fb_exchange_token&client_id=${a}&client_secret=${o}&fb_exchange_token=${s}`,type:"GET",dataType:"json",success:function(e){if(void 0!==e.access_token)t.getPageAccessToken(c,e.access_token,n);else{const e=tribe_events_virtual_facebook_settings_strings.userTokenFailure,a="no user access token";t.displayMessage(`${e}: ${a}`,"error")}},error:function(e,a,o){const s=tribe_events_virtual_facebook_settings_strings.userTokenFailure;t.displayMessage(`${s}: ${o}`,"error")}});else{const e=tribe_events_virtual_facebook_settings_strings.userTokenFailure,a="missing parameter";t.displayMessage(`${e}: ${a}`,"error")}},t.facebookAuthorization=function(a){if(a.length<1)return void t.displayMessage(tribe_events_virtual_facebook_settings_strings.localIdFailure,"error");const o=e(t.selectors.facebookContainer).find(`[data-local-id='${a}']`);void 0!==o?FB.getLoginStatus(function(a){if("connected"!==a.status)return void t.displayMessage(tribe_events_virtual_facebook_settings_strings.connectionFailure,"error");const s=a.authResponse.accessToken,c=e(t.selectors.facebookAppId).val(),n=e(t.selectors.facebookAppSecret).val(),i=o.find(t.selectors.facebookPageId).val();t.getExtendedAccessToken(c,n,s,i,o)}):t.displayMessage(tribe_events_virtual_facebook_settings_strings.pageWrapFailure,"error")},t.onAddPageSuccess=function(a){const o=e(a).filter(t.selectors.messageWrap),s=e(a).filter(t.selectors.facebookPageContainer);e(t.selectors.facebookPageMessageContainer).html(o),0!==s.length&&e(t.selectors.facebookPageList).append(s)},t.handleAddPage=function(a){a.preventDefault();const o=e(this).attr("href");e.ajax(o,{contentType:"application/json",context:e(t.selectors.facebookPageList),success:t.onAddPageSuccess})},t.handleAutoDetectFacebookVideo=function(a,o){if(!o.html)return;0!==e(o.html).filter(t.selectors.autoDetectPreviewClass).length&&t.facebookInit()},t.bindEvents=function(){a.on("change",`${t.selectors.facebookPageName}, ${t.selectors.facebookPageId}`,t.handleEnableSave).on("click",t.selectors.facebookSaveAppBtn,t.handleSaveApp).on("click",t.selectors.facebookSavePage,t.handleSavePage).on("click",t.selectors.facebookClearAccess,t.handleClearAccess).on("click",t.selectors.facebookDeletePage,t.handleDeletePage),e(t.selectors.facebookContainer).on("click",t.selectors.facebookAddPage,t.handleAddPage),a.on("autodetect.videoPreview",t.handleAutoDetectFacebookVideo)},t.ready=function(){t.bindEvents(),window.facebookAsyncInit=t.facebookInit()},e(t.ready)}(jQuery,tribe.events.facebookSettingsAdmin);